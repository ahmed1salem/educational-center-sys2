<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ (Ø³Ø­Ø§Ø¨Ù‰)</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Tajawal', sans-serif; 
        }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        
        #login-screen, #loader-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: #343a40; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
        }
        #login-box { 
            background: white; 
            padding: 2rem; 
            border-radius: 0.5rem; 
            width: 100%; 
            max-width: 400px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.2); 
        }
        #app-wrapper { display: none; }
        .main-content .page { display: none; }
        .main-content .page.active { display: block; }
        
        .sidebar { 
            height: calc(100vh - 56px);
            position: sticky; 
            top: 56px;
            background-color: #343a40; 
            color: white; 
            overflow-y: auto; 
        }
        .sidebar .nav-link { 
            color: #adb5bd; cursor: pointer; border-radius: 0.25rem; margin-bottom: 0.25rem; display: flex; align-items: center;
        }
        .sidebar .nav-link i { margin-left: 10px; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: #495057; }

        .offcanvas-body .nav-link { color: #adb5bd; font-size: 1.1rem; padding: 0.75rem 1rem; }
        .offcanvas-body .nav-link:hover, .offcanvas-body .nav-link.active { color: white; background-color: #495057; }

        .stat-card { border: none; border-radius: 0.5rem; color: white; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
        .card-icon { font-size: 3rem; opacity: 0.7; }
        #receipt-modal-content { font-family: 'Courier New', Courier, monospace; text-align: center; }
        .table-responsive { max-height: 450px; overflow-y: auto; }
        .card { border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .navbar-brand { font-weight: bold; }
    </style>
</head>
<body>

<!-- Loader Screen -->
<div id="loader-screen">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
    </div>
</div>

<!-- Login Screen -->
<div id="login-screen" style="display: none;">
    <div id="login-box" class="text-center">
        <h3 class="mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <form id="login-form">
            <div class="form-floating mb-3">
                <input type="email" class="form-control" id="email" placeholder="name@example.com" required>
                <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            </div>
            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="password" placeholder="Password" required>
                <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            </div>
            <button type="submit" class="btn btn-primary w-100">Ø¯Ø®ÙˆÙ„</button>
            <div id="login-error" class="text-danger mt-2" style="display: none;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.</div>
        </form>
    </div>
</div>

<div id="app-wrapper">
    <!-- Top Navbar -->
    <nav class="navbar navbar-dark bg-dark sticky-top flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobile-sidebar" aria-controls="mobile-sidebar">
            <span class="navbar-toggler-icon"></span>
        </button>
    </nav>

    <!-- Mobile Sidebar (Offcanvas) -->
    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="mobile-sidebar" aria-labelledby="mobile-sidebar-label">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="mobile-sidebar-label">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <ul class="nav flex-column" id="mobile-nav-links">
                <!-- Links will be dynamically inserted here -->
            </ul>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Desktop Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-none d-md-block sidebar p-3">
                <ul class="nav flex-column" id="desktop-nav-links">
                    <!-- Links will be dynamically inserted here -->
                </ul>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 pt-4 main-content">
                <!-- All pages are the same as before -->
                 <div id="dashboard" class="page active">
                    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                    <div class="row mt-4">
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card bg-primary p-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ø·Ù„Ø§Ø¨</h5><h2 id="total-students-stat">0</h2></div><div class="card-icon">ğŸ§‘â€ğŸ“</div></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card bg-info p-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ù…Ø¯Ø±Ø³ÙˆÙ†</h5><h2 id="total-teachers-stat">0</h2></div><div class="card-icon">ğŸ‘¨â€ğŸ«</div></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card bg-secondary p-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h5><h2 id="total-groups-stat">0</h2></div><div class="card-icon">ğŸ“š</div></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card stat-card bg-success p-3"><div class="d-flex justify-content-between align-items-center"><div><h5>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h5><h2 id="total-revenue-stat">0</h2></div><div class="card-icon">ğŸ’µ</div></div></div></div>
                    </div>
                </div>
                
                <div id="teachers" class="page">
                     <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h3>
                    <div class="card p-3 mb-4"><form id="add-teacher-form" class="row g-3 align-items-end"><div class="col-md-5"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³</label><input type="text" id="teacher-name" class="form-control" required></div><div class="col-md-4"><label class="form-label">Ø§Ù„Ù…Ø§Ø¯Ø©</label><input type="text" id="teacher-subject" class="form-control" required></div><div class="col-md-2"><label class="form-label">Ø§Ù„Ù†Ø³Ø¨Ø© (%)</label><input type="number" id="teacher-percentage" class="form-control" required min="0" max="100"></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">Ø¥Ø¶Ø§ÙØ©</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="teachers-table-body"></tbody></table></div></div>
                </div>

                <div id="groups" class="page">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h3>
                    <div class="card p-3 mb-4"><form id="add-group-form" class="row g-3 align-items-end"><div class="col-md-4"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><input type="text" id="group-name" class="form-control" required></div><div class="col-md-3"><label class="form-label">Ø§Ù„Ù…Ø¯Ø±Ø³</label><select id="group-teacher" class="form-select" required></select></div><div class="col-md-4"><label class="form-label">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</label><input type="text" id="group-schedule" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¨Øª - Ø§Ø«Ù†ÙŠÙ† (5Ù…)" required></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">Ø¥Ù†Ø´Ø§Ø¡</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…Ø¯Ø±Ø³</th><th>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="groups-table-body"></tbody></table></div></div>
                </div>

                <div id="students" class="page">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <div class="card p-3 mb-4"><form id="add-student-form" class="row g-3 align-items-end"><div class="col-md-3"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label><input type="text" id="name" class="form-control" required></div><div class="col-md-3"><label class="form-label">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label><input type="text" id="stage" class="form-control" required></div><div class="col-md-3"><label class="form-label">Ù‡Ø§ØªÙ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label><input type="tel" id="parentPhone" class="form-control" required></div><div class="col-md-2"><label class="form-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><select id="student-group" class="form-select" required></select></div><div class="col-md-1"><button type="submit" class="btn btn-primary w-100">Ø¥Ø¶Ø§ÙØ©</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h5><input type="text" id="search-student" class="form-control mb-3" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..."><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="students-table-body"></tbody></table></div></div>
                </div>

                <div id="attendance" class="page">
                    <h3>Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</h3>
                    <div class="card p-3 mb-4">
                        <h5>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h5>
                        <p>Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù†Ø­Ùˆ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø¯Ù†Ø§Ù‡.</p>
                        <input type="text" id="barcode-input" class="form-control form-control-lg" placeholder="ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯...">
                        <div id="attendance-feedback" class="mt-3"></div>
                    </div>
                     <div class="card p-3">
                        <h5 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h5>
                        <div class="row mb-3 g-3">
                            <div class="col-md-4"><label class="form-label">ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="attendance-date-filter" class="form-control"></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
                                <tbody id="attendance-log-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="grades" class="page">
                    <h3>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</h3>
                    <div class="card p-3 mb-4">
                        <h5>Ø¥Ø¶Ø§ÙØ© Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯</h5>
                        <form id="add-exam-form" class="row g-3 align-items-end">
                            <div class="col-md-5"><label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><select id="exam-group" class="form-select" required></select></div>
                            <div class="col-md-5"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label><input type="text" id="exam-name" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù…ØªØ­Ø§Ù† Ø´Ù‡Ø± Ø£ÙƒØªÙˆØ¨Ø±" required></div>
                            <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Ø¨Ø¯Ø¡ Ø§Ù„Ø±ØµØ¯</button></div>
                        </form>
                    </div>
                    <div class="card p-3 mb-4" id="grades-entry-card" style="display:none;">
                        <h5 id="grades-entry-title"></h5>
                        <div class="table-responsive"><table class="table"><thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead><tbody id="grades-entry-body"></tbody></table></div>
                        <button class="btn btn-success mt-3" id="save-grades-btn">Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
                    </div>
                     <div class="card p-3">
                        <h5 class="card-title">Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h5>
                        <div class="row g-3 mb-3 align-items-end">
                            <div class="col-md-5"><label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label><select id="view-exam-group-filter" class="form-select"></select></div>
                            <div class="col-md-5"><label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</label><select id="view-exam-filter" class="form-select"></select></div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead><tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead>
                                <tbody id="exam-results-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="finance" class="page">
                    <h3>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
                    <div class="card p-3 mb-4"><form id="add-payment-form" class="row g-3 align-items-end"><div class="col-md-5"><label class="form-label">ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨</label><input type="text" class="form-control" id="payment-student-id" required></div><div class="col-md-5"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input type="number" class="form-control" id="payment-amount" required></div><div class="col-md-2"><button type="submit" class="btn btn-success w-100">ØªØ³Ø¬ÙŠÙ„</button></div></form></div>
                    <div class="card p-3"><h5 class="card-title">Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†</h5><div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø§Ù„Ù…Ø¯Ø±Ø³</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th><th>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</th><th>Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³</th></tr></thead><tbody id="teacher-finances-table-body"></tbody></table></div></div>
                </div>
                
                 <div id="student-details" class="page">
                    <button class="btn btn-secondary mb-3" onclick="showPage('students')"><i class="bi bi-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                    <h3 id="student-details-name"></h3>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card p-3">
                                <h5 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆÙ‚Øª</th></tr></thead>
                                        <tbody id="student-attendance-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card p-3">
                                <h5 class="card-title">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead><tr><th>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</th><th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th></tr></thead>
                                        <tbody id="student-grades-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<div class="modal fade" id="receiptModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Ø¥ÙŠØµØ§Ù„ Ø§Ø³ØªÙ„Ø§Ù…</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="receipt-modal-content"></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button><button type="button" class="btn btn-primary" onclick="printReceipt()">Ø·Ø¨Ø§Ø¹Ø©</button></div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
// ===================================================================================
// ===== Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª FIREBASE =====
// ===================================================================================
// 1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ https://console.firebase.google.com
// 2. Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ (Project).
// 3. ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙˆÙŠØ¨ (</>) Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯.
// 4. Ø£Ø¹Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ø³Ù…Ø§Ù‹ (Ù…Ø«Ù„Ø§Ù‹: "Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ²") Ø«Ù… Ø§Ø¶ØºØ· "Register app".
// 5. Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ø´ÙØ±Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ `firebaseConfig`. Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¦Ù† (object) ÙˆØ§Ù„ØµÙ‚Ù‡ Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø£Ø³ÙÙ„.
// 6. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… "Authentication" ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø´Ø±ÙˆØ¹ÙƒØŒ Ø§Ø®ØªØ± "Sign-in method"ØŒ ÙˆÙ‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ "Email/Password".
// 7. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… "Firestore Database"ØŒ Ø§Ø¶ØºØ· "Create database"ØŒ Ø§Ø®ØªØ± "Start in test mode" (Ù„Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹)ØŒ ÙˆØ§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ.
//
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCGhbk9D_iGaqiSMVirdjMha7kVM03km9I",
  authDomain: "educational-center-sys.firebaseapp.com",
  projectId: "educational-center-sys",
  storageBucket: "educational-center-sys.firebasestorage.app",
  messagingSenderId: "223720761047",
  appId: "1:223720761047:web:5c4014e231d25c847ef292",
  measurementId: "G-J992M6RNRV"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// ===================================================================================

let currentStudentDetailsId = null;
let allStudents = [];
let allGroups = [];
let allTeachers = [];
let allExams = [];

// ===== AUTH LOGIC =====
auth.onAuthStateChanged(user => {
    const loader = document.getElementById('loader-screen');
    const loginScreen = document.getElementById('login-screen');
    const appWrapper = document.getElementById('app-wrapper');

    if (user) {
        // User is signed in.
        loader.style.display = 'none';
        loginScreen.style.display = 'none';
        appWrapper.style.display = 'block';
        initializeApp();
    } else {
        // User is signed out.
        loader.style.display = 'none';
        loginScreen.style.display = 'flex';
        appWrapper.style.display = 'none';
    }
});

function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const loginError = document.getElementById('login-error');

    auth.signInWithEmailAndPassword(email, password)
        .catch(error => {
            console.error("Login Error:", error);
            loginError.style.display = 'block';
        });
}

function logout() {
    auth.signOut();
}


// ===== UI LOGIC =====
function showPage(pageId, studentId = null) {
    currentStudentDetailsId = studentId; 
    document.querySelectorAll('.main-content .page').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    
    const navLinks = document.querySelectorAll('.sidebar .nav-link, .offcanvas-body .nav-link');
    navLinks.forEach(l => l.classList.remove('active'));
    
    const activeLinks = document.querySelectorAll(`.nav-link[onclick*="showPage('${pageId}')"]`);
    activeLinks.forEach(link => {
        if (!link.closest('#student-details')) {
             link.classList.add('active');
        }
    });

    if (pageId === 'student-details') renderStudentDetails();
    if (pageId === 'grades') { populateGroupsDropdown('exam-group'); populateGroupsDropdown('view-exam-group-filter'); }
    if (pageId === 'students') { populateGroupsDropdown('student-group'); }
    if (pageId === 'groups') { populateTeachersDropdown(); }
}

// ===== REAL-TIME DATA LISTENERS =====
function setupRealtimeListeners() {
    db.collection('teachers').onSnapshot(snapshot => {
        allTeachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTeachersTable();
        renderTeacherFinances();
        populateTeachersDropdown();
    });

    db.collection('groups').onSnapshot(snapshot => {
        allGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderGroupsTable();
        populateGroupsDropdown('student-group');
        populateGroupsDropdown('exam-group');
        populateGroupsDropdown('view-exam-group-filter');
    });

    db.collection('students').onSnapshot(snapshot => {
        allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderStudentsTable();
        renderDashboard();
    });
    
    db.collection('payments').onSnapshot(snapshot => {
        const payments = snapshot.docs.map(doc => doc.data());
        renderDashboard(payments);
        renderTeacherFinances();
    });

    db.collection('attendance').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
        const attendance = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        renderAttendanceLog(attendance);
    });

    db.collection('exams').onSnapshot(snapshot => {
        allExams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        populateExamFilter();
    });
}


// ===== RENDER FUNCTIONS (Now use local arrays updated by listeners) =====
function renderDashboard(payments = null) {
    document.getElementById('total-students-stat').innerText = allStudents.length;
    document.getElementById('total-teachers-stat').innerText = allTeachers.length;
    document.getElementById('total-groups-stat').innerText = allGroups.length;
    if (payments) {
        const totalRevenue = payments.reduce((sum, p) => sum + p.amount, 0);
        document.getElementById('total-revenue-stat').innerText = `${totalRevenue} Ø¬`;
    }
}

function renderTeachersTable() {
    const tableBody = document.getElementById('teachers-table-body');
    tableBody.innerHTML = '';
    allTeachers.forEach(t => { tableBody.innerHTML += `<tr><td>${t.name}</td><td>${t.subject}</td><td>${t.percentage}%</td><td><button class="btn btn-danger btn-sm" onclick="deleteData('teachers', '${t.id}')">Ø­Ø°Ù</button></td></tr>`; });
}

function populateTeachersDropdown() {
    const select = document.getElementById('group-teacher');
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³...</option>';
    allTeachers.forEach(t => { select.innerHTML += `<option value="${t.name}">${t.name}</option>`; });
}

function renderGroupsTable() {
    const tableBody = document.getElementById('groups-table-body');
    tableBody.innerHTML = '';
    allGroups.forEach(g => {
        tableBody.innerHTML += `<tr><td>${g.name}</td><td>${g.teacherName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td><td>${g.schedule}</td><td><button class="btn btn-danger btn-sm" onclick="deleteData('groups', '${g.id}')">Ø­Ø°Ù</button></td></tr>`;
    });
}

function populateGroupsDropdown(selectId) {
    const select = document.getElementById(selectId);
    const currentValue = select.value;
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø¬Ù…ÙˆØ¹Ø©...</option>';
    allGroups.forEach(g => { select.innerHTML += `<option value="${g.id}">${g.name}</option>`; });
    select.value = currentValue;
}

function renderStudentsTable(filter = '') {
    const tableBody = document.getElementById('students-table-body');
    tableBody.innerHTML = '';
    const filteredStudents = allStudents.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()) || s.barcode.toLowerCase().includes(filter.toLowerCase()));
    filteredStudents.forEach(s => {
        const group = allGroups.find(g => g.id === s.groupId);
        tableBody.innerHTML += `<tr>
            <td>${s.name}</td>
            <td>${s.barcode}</td>
            <td>${group ? group.name : 'Ø¨Ù„Ø§ Ù…Ø¬Ù…ÙˆØ¹Ø©'}</td>
            <td>${s.stage}</td>
            <td>
                <button class="btn btn-info btn-sm" onclick="showPage('student-details', '${s.id}')">Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
                <button class="btn btn-danger btn-sm" onclick="deleteData('students', '${s.id}')">Ø­Ø°Ù</button>
            </td>
        </tr>`;
    });
}

function renderTeacherFinances() {
     db.collection('payments').get().then(paymentSnapshot => {
        const payments = paymentSnapshot.docs.map(doc => doc.data());
        const tableBody = document.getElementById('teacher-finances-table-body');
        tableBody.innerHTML = '';
        allTeachers.forEach(teacher => {
            const teacherGroups = allGroups.filter(g => g.teacherName === teacher.name);
            const teacherGroupIds = teacherGroups.map(g => g.id);
            const teacherStudentIds = allStudents.filter(s => teacherGroupIds.includes(s.groupId)).map(s => s.id);
            const totalRevenue = payments.filter(p => teacherStudentIds.includes(p.studentId)).reduce((sum, p) => sum + p.amount, 0);
            const teacherShare = totalRevenue * (teacher.percentage / 100);
            tableBody.innerHTML += `<tr><td>${teacher.name}</td><td>${totalRevenue.toFixed(2)} Ø¬</td><td>${teacher.percentage}%</td><td>${teacherShare.toFixed(2)} Ø¬</td></tr>`;
        });
    });
}

function renderAttendanceLog(attendanceData) {
    const dateFilter = document.getElementById('attendance-date-filter').value;
    const tableBody = document.getElementById('attendance-log-body');
    tableBody.innerHTML = '';

    let filteredData = attendanceData;
    if (dateFilter) {
        filteredData = attendanceData.filter(att => att.timestamp.toDate().toISOString().startsWith(dateFilter));
    }

    filteredData.forEach(att => {
        const student = allStudents.find(s => s.id === att.studentId);
        if (student) {
            const group = allGroups.find(g => g.id === student.groupId);
            const aDate = att.timestamp.toDate();
            tableBody.innerHTML += `<tr>
                <td>${student.name}</td>
                <td>${group ? group.name : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                <td>${aDate.toLocaleDateString('ar-EG')}</td>
                <td>${aDate.toLocaleTimeString('ar-EG')}</td>
            </tr>`;
        }
    });
}

function populateExamFilter() {
    const groupId = document.getElementById('view-exam-group-filter').value;
    const examSelect = document.getElementById('view-exam-filter');
    examSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù…ØªØ­Ø§Ù†...</option>';
    if (groupId) {
        const groupExams = allExams.filter(ex => ex.groupId === groupId);
        groupExams.forEach(ex => {
            examSelect.innerHTML += `<option value="${ex.id}">${ex.name}</option>`;
        });
    }
    renderExamResults();
}

function renderExamResults() {
    const examId = document.getElementById('view-exam-filter').value;
    const tableBody = document.getElementById('exam-results-body');
    tableBody.innerHTML = '';
    if (examId) {
        const exam = allExams.find(ex => ex.id === examId);
        if (exam) {
            exam.grades.forEach(grade => {
                const student = allStudents.find(s => s.id === grade.studentId);
                tableBody.innerHTML += `<tr>
                    <td>${student ? student.name : 'Ø·Ø§Ù„Ø¨ Ù…Ø­Ø°ÙˆÙ'}</td>
                    <td>${grade.grade}</td>
                </tr>`;
            });
        }
    }
}

function renderStudentDetails() {
    if (!currentStudentDetailsId) return;
    const student = allStudents.find(s => s.id === currentStudentDetailsId);
    if (!student) {
        showPage('students');
        return;
    }

    document.getElementById('student-details-name').innerText = `ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}`;
    
    db.collection('attendance').where('studentId', '==', student.id).orderBy('timestamp', 'desc').get().then(snapshot => {
        const attendanceBody = document.getElementById('student-attendance-body');
        attendanceBody.innerHTML = '';
        snapshot.forEach(doc => {
            const aDate = doc.data().timestamp.toDate();
            attendanceBody.innerHTML += `<tr><td>${aDate.toLocaleDateString('ar-EG')}</td><td>${aDate.toLocaleTimeString('ar-EG')}</td></tr>`;
        });
    });

    const gradesBody = document.getElementById('student-grades-body');
    gradesBody.innerHTML = '';
    allExams.forEach(exam => {
        const gradeInfo = exam.grades.find(g => g.studentId === student.id);
        if (gradeInfo) {
            gradesBody.innerHTML += `<tr><td>${exam.name}</td><td>${gradeInfo.grade}</td></tr>`;
        }
    });
}

// ===== DATA HANDLING LOGIC (Now uses Firestore) =====
function addTeacher(e) {
    e.preventDefault();
    db.collection('teachers').add({
        name: document.getElementById('teacher-name').value,
        subject: document.getElementById('teacher-subject').value,
        percentage: parseInt(document.getElementById('teacher-percentage').value)
    }).then(() => e.target.reset());
}

function addGroup(e) {
    e.preventDefault();
    db.collection('groups').add({
        name: document.getElementById('group-name').value,
        teacherName: document.getElementById('group-teacher').value,
        schedule: document.getElementById('group-schedule').value
    }).then(() => e.target.reset());
}

function addStudent(e) {
    e.preventDefault();
    const studentBarcode = `STU-${Date.now()}`;
    db.collection('students').add({
        name: document.getElementById('name').value,
        stage: document.getElementById('stage').value,
        parentPhone: document.getElementById('parentPhone').value,
        groupId: document.getElementById('student-group').value,
        barcode: studentBarcode
    }).then(() => {
        alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ (Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯) Ù‡Ùˆ: ${studentBarcode}`);
        e.target.reset();
    });
}

function addPayment(e) {
    e.preventDefault();
    const studentBarcode = document.getElementById('payment-student-id').value;
    const student = allStudents.find(s => s.barcode === studentBarcode);
    if (!student) { alert('Ø®Ø·Ø£: ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); return; }
    
    const newPayment = { 
        studentId: student.id, 
        amount: parseFloat(document.getElementById('payment-amount').value), 
        date: new Date()
    };
    
    db.collection('payments').add(newPayment).then(() => {
        document.getElementById('receipt-modal-content').innerHTML = `<h5>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h5><p>-------------------------</p><p><strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> ${student.name}</p><p><strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${newPayment.amount.toFixed(2)} Ø¬</p><p>-------------------------</p><p>Ø´ÙƒØ±Ù‹Ø§ Ù„ÙƒÙ…!</p>`;
        new bootstrap.Modal(document.getElementById('receiptModal')).show();
        e.target.reset();
    });
}

function handleAttendance(e) {
    const barcode = e.target.value.trim();
    if (barcode === '') return;
    const student = allStudents.find(s => s.barcode === barcode);
    const feedbackEl = document.getElementById('attendance-feedback');
    if (student) {
        db.collection('attendance').add({
            studentId: student.id,
            timestamp: new Date()
        });
        feedbackEl.innerHTML = `<div class="alert alert-success"><strong>Ø­Ø¶ÙˆØ±:</strong> ${student.name}<br><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${new Date().toLocaleTimeString()}</div>`;
    } else {
        feedbackEl.innerHTML = `<div class="alert alert-danger"><strong>Ø®Ø·Ø£:</strong> Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…Ø³Ø¬Ù„.</div>`;
    }
    setTimeout(() => { e.target.value = ''; feedbackEl.innerHTML = ''; e.target.focus(); }, 3000);
}

function startGradesEntry(e) {
    e.preventDefault();
    const groupId = document.getElementById('exam-group').value;
    const examName = document.getElementById('exam-name').value;
    if (!groupId) { alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹.'); return; }

    const studentsInGroup = allStudents.filter(s => s.groupId === groupId);
    const tableBody = document.getElementById('grades-entry-body');
    tableBody.innerHTML = '';
    
    studentsInGroup.forEach(student => {
        tableBody.innerHTML += `<tr><td>${student.name}</td><td><input type="number" class="form-control grade-input" data-student-id="${student.id}" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø©"></td></tr>`;
    });
    
    document.getElementById('grades-entry-title').innerText = `Ø±ØµØ¯ Ø¯Ø±Ø¬Ø§Øª Ø§Ù…ØªØ­Ø§Ù† "${examName}"`;
    document.getElementById('grades-entry-card').style.display = 'block';
}

function saveGrades() {
    const examName = document.getElementById('exam-name').value;
    const groupId = document.getElementById('exam-group').value;
    const gradeInputs = document.querySelectorAll('.grade-input');
    
    const newExam = {
        name: examName,
        groupId: groupId,
        grades: []
    };

    gradeInputs.forEach(input => {
        if (input.value) {
            newExam.grades.push({
                studentId: input.dataset.studentId,
                grade: parseFloat(input.value)
            });
        }
    });

    db.collection('exams').add(newExam).then(() => {
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        document.getElementById('grades-entry-card').style.display = 'none';
        document.getElementById('add-exam-form').reset();
    });
}

function deleteData(collectionName, id) {
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©.`)) {
        db.collection(collectionName).doc(id).delete().catch(error => console.error("Error removing document: ", error));
    }
}

// ===== APP INITIALIZATION =====
function initializeApp() {
    // Generate nav links
    const navItems = `
        <li class="nav-item"><a class="nav-link active" onclick="showPage('dashboard')" data-bs-dismiss="offcanvas"><i class="bi bi-grid-1x2-fill"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('teachers')" data-bs-dismiss="offcanvas"><i class="bi bi-person-video3"></i> Ø§Ù„Ù…Ø¯Ø±Ø³ÙˆÙ†</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('groups')" data-bs-dismiss="offcanvas"><i class="bi bi-collection-fill"></i> Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('students')" data-bs-dismiss="offcanvas"><i class="bi bi-people-fill"></i> Ø§Ù„Ø·Ù„Ø§Ø¨</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('attendance')" data-bs-dismiss="offcanvas"><i class="bi bi-check-circle-fill"></i> Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('grades')" data-bs-dismiss="offcanvas"><i class="bi bi-pencil-square"></i> Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª</a></li>
        <li class="nav-item"><a class="nav-link" onclick="showPage('finance')" data-bs-dismiss="offcanvas"><i class="bi bi-cash-stack"></i> Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</a></li>
        <li class="nav-item mt-3"><a class="nav-link text-warning" onclick="logout()" data-bs-dismiss="offcanvas"><i class="bi bi-box-arrow-right"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a></li>
    `;
    document.getElementById('desktop-nav-links').innerHTML = navItems;
    document.getElementById('mobile-nav-links').innerHTML = navItems;

    setupRealtimeListeners();
    showPage('dashboard');

    // Setup event listeners once
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('add-teacher-form').addEventListener('submit', addTeacher);
    document.getElementById('add-group-form').addEventListener('submit', addGroup);
    document.getElementById('add-student-form').addEventListener('submit', addStudent);
    document.getElementById('search-student').addEventListener('keyup', (e) => renderStudentsTable(e.target.value));
    document.getElementById('barcode-input').addEventListener('change', handleAttendance);
    document.getElementById('add-payment-form').addEventListener('submit', addPayment);
    document.getElementById('add-exam-form').addEventListener('submit', startGradesEntry);
    document.getElementById('save-grades-btn').addEventListener('click', saveGrades);
    document.getElementById('attendance-date-filter').addEventListener('change', () => {
        db.collection('attendance').orderBy('timestamp', 'desc').get().then(snapshot => renderAttendanceLog(snapshot.docs.map(d=>({id: d.id, ...d.data()}))));
    });
    document.getElementById('view-exam-group-filter').addEventListener('change', populateExamFilter);
    document.getElementById('view-exam-filter').addEventListener('change', renderExamResults);
}

function printReceipt() {
    const receiptContent = document.getElementById('receipt-modal-content').innerHTML;
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„</title>');
    printWindow.document.write('<style>body { text-align: center; font-family: "Courier New", monospace; }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(receiptContent);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}
</script>

</body>
</html>
